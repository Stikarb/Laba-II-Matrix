# ==============================================================================
#  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
# ==============================================================================

# --------------------------------
#  –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∏ —Ñ–ª–∞–≥–∏
# --------------------------------
CC       = gcc
CFLAGS   = -Wall -Wextra -std=c11 -g -D_POSIX_C_SOURCE=200809L
INCLUDES = -Iinclude -Isrc -Isrc/matrix -Isrc/output
TEST_LDFLAGS = -lcunit

# --------------------------------
#  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
# --------------------------------
SRC_DIR   = src
TEST_DIR  = tests
BUILD_DIR = build
DATA_DIR  = data

# ==============================================================================
#  –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
# ==============================================================================

# --------------------------------
#  –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
# --------------------------------
SRCS = $(wildcard $(SRC_DIR)/*.c) \
       $(wildcard $(SRC_DIR)/matrix/*.c) \
       $(wildcard $(SRC_DIR)/output/*.c) \
       $(wildcard $(SRC_DIR)/errors/*.c)

OBJS = $(patsubst $(SRC_DIR)/%, $(BUILD_DIR)/%, $(SRCS:.c=.o))

# --------------------------------
#  –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
# --------------------------------
TEST_SRCS = $(wildcard $(TEST_DIR)/*.c)
TEST_OBJS = $(patsubst $(TEST_DIR)/%, $(BUILD_DIR)/$(TEST_DIR)/%, $(TEST_SRCS:.c=.o))

# --------------------------------
#  –¶–µ–ª–∏ —Å–±–æ—Ä–∫–∏
# --------------------------------
TARGET      = $(BUILD_DIR)/matrix_app
TEST_TARGET = $(BUILD_DIR)/matrix_tests

# ==============================================================================
#  –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏
# ==============================================================================
.PHONY: all clean run test init_data help format docs docs-open docs-clean

all: $(TARGET)

$(TARGET): $(OBJS)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCLUDES) $^ -o $@
	@echo "–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ: $@"

$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# ==============================================================================
#  –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ==============================================================================

test: $(TEST_TARGET)
	@echo "\nüîç <<< –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í >>>"
	@./$(TEST_TARGET)

$(TEST_TARGET): $(TEST_OBJS) $(filter-out $(BUILD_DIR)/main.o, $(OBJS))
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCLUDES) $^ -o $@ $(TEST_LDFLAGS)
	@echo "–¢–µ—Å—Ç–æ–≤—ã–π –º–æ–¥—É–ª—å —Å–æ–±—Ä–∞–Ω: $@"

$(BUILD_DIR)/$(TEST_DIR)/%.o: $(TEST_DIR)/%.c
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# ==============================================================================
#  –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏
# ==============================================================================

# --------------------------------
#  –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
# --------------------------------
format:
	@echo "<<< –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–î–ê >>>"
	@find $(SRC_DIR) $(TEST_DIR) include -name '*.c' -o -name '*.h' | \
		xargs clang-format --style=file -i -Werror
	@echo "–ì–æ—Ç–æ–≤–æ"


# --------------------------------
#  –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
# --------------------------------
clean:
	@rm -rf $(BUILD_DIR)
	@echo "–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"

# --------------------------------
#  –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# --------------------------------
run: $(TARGET) init_data
	@echo "\n<<< –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø >>>"
	@./$(TARGET)

# ==============================================================================
#  –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
# ==============================================================================
DOXYFILE      = Doxyfile
DOCS_HTML_DIR = docs/html

docs:
	@echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Doxygen..."
	@doxygen $(DOXYFILE)
	@echo "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ $(DOCS_HTML_DIR)/"

docs-open: docs
	@echo "\n–û—Ç–∫—Ä—ã—Ç–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ..."
	@if [ -f "$(DOCS_HTML_DIR)/index.html" ]; then \
		if command -v xdg-open > /dev/null; then \
			xdg-open "$(DOCS_HTML_DIR)/index.html"; \
		elif command -v open > /dev/null; then \
			open "$(DOCS_HTML_DIR)/index.html"; \
		elif command -v start > /dev/null; then \
			start "$(DOCS_HTML_DIR)/index.html"; \
		else \
			echo "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –±—Ä–∞—É–∑–µ—Ä–∞"; \
		fi \
	else \
		echo "–û—à–∏–±–∫–∞: –§–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $(DOCS_HTML_DIR)/index.html"; \
		echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã 'make docs' –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫"; \
		exit 1; \
	fi

docs-clean:
	@echo "–£–¥–∞–ª–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."
	@rm -rf $(DOCS_HTML_DIR) docs/latex/ docs/xml/ docs/man/ docs/rtf/
	@echo "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ—á–∏—â–µ–Ω–∞"

# ==============================================================================
#  –°–ø—Ä–∞–≤–∫–∞
# ==============================================================================
help:
	@echo "  –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo ""
	@echo "  –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "    make all        - –°–æ–±—Ä–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
	@echo "    make test       - –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"
	@echo "    make run        - –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"
	@echo ""
	@echo "  –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "    make init_data  - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ"
	@echo "    make clean      - –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
	@echo "    make format     - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
	@echo ""
	@echo "  –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:"
	@echo "    make docs       - –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
	@echo "    make docs-open  - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"
	@echo "    make docs-clean - –£–¥–∞–ª–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"
	@echo ""
	@echo "    make help       - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"

